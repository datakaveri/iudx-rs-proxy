<p align="center">
<img src="./cdpg.png" width="300">
</p>

# Tokens, Users and Roles

## Tokens used in DX

- Tokens for a user could be created using DX AAA Server
  API : [link to the API docs](https://authorization.iudx.org.in/apis#tag/Token-APIs/operation/post-auth-v1-token). The
  token used in DX are :

| Token             |                                                                                     Purpose                                                                                     | Users                                                                      |
|:------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------|
| DX Identity token |                                          Serves as an identifier of the user to the server to access the ACL-APD Server's capabilities                                          | Provider, provider delegate, consumer, consumer delegate, cos admin, admin |
| Keycloak token    | Access token as bearer credential is generated by Keycloak by providing the client's email ID and password and then adding bearer to the access token : `bearer <access-token>` | DX AAA Server, Users                                                       |
| Access token      |                                                                    To get access to resource, resource group                                                                    | Provider, provider delegate, consumer, consumer delegate                   |

# Access Policy

| Access policy |                                                                     Description                                                                     |
|:--------------|:---------------------------------------------------------------------------------------------------------------------------------------------------:|
| Open/Public   |                                           These resources can be accessed using any valid DX access token                                           |
| Secure/Close  | Resources under this policy can only be accessed with a secure/close token. The token must be associated with the specific resource being requested |
| PII           |                     Resources containing PII require a secure/private token, which must be linked to the appropriate PPbNumber                      |

## Tokens accepted in DX Rs-proxy Server

The DX Rs-proxy server accepts authentication tokens (JWT tokens) issued by the DX AAA server, including identity
tokens, open tokens, and close tokens as appropriate.

| API            |                        Users                        | Token                                                     |
|:---------------|:---------------------------------------------------:|:----------------------------------------------------------|
| Search APIs    | admin,Provider, provider delegate,consumer,delegate | any Access and Identity token issued by the DX AAA server |
| Async APIs     | admin,Provider, provider delegate,consumer,delegate | any Access and Identity token issued by the DX AAA server |
| metering Apis  | admin,Provider, provider delegate,consumer,delegate | any Access and Identity token issued by the DX AAA server |
| Connector API  |             Provider, provider delegate             | provider or delegate token                                |
| Management API |             Consumer, consumer delegate             | consumer token                                            |

**Note** : All the Search API calls to the resource server proxy should now contain a valid data exchange auth token
presented in the query header. To search (or) access an Open resource, the consumer should present a valid data exchange
Auth token. To search (or) access a Secure / Closed resource, a consumer must get a token for the Secure / Closed
resource along with the associated constraints from the DX(Data exchange) Auth Server. For subscription to a Secure /
Closed / Open resource, a consumer must get a token along with the associated constraints from the DX(Data exchange)
Auth Server.

## Users and Roles

All registered users of DX can access the DX RS-proxy Server. The DX RS-proxy Server identifies the user based on the
token information which is provided by DX AAA Server.

How is the user considered as a consumer, provider or delegate?

- While decoding the token at the DX RS-proxy Server, the **role** in token fetched from DX AAA Server and then the
  following rules is applied to identify the user
    - A user is considered as a **provider** if **role** is **provider**
    - A user is considered as a **consumer** if **role** is **consumer**
    - A user is considered as a delegate of the consumer if **role** is **delegate** and **drl** is **consumer**
    - A user is considered as a delegate of the provider if **role** is **delegate** and **drl** is **provider**

## Terminologies and Definitions

- **Delegate** : Consumer or provider appointed user who could act on behalf of the delegator
- **Access Policy** : The ability or permission granted to a user (consumer or provider) to interact with a resource,
  based on specific access policies such as secure, open, or PII-protected. Access is typically controlled via
  authentication tokens (e.g., secure/close token, open token, etc.).

